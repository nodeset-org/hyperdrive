# Autogenerated - DO NOT MODIFY THIS FILE DIRECTLY 
# If you want to overwrite some of these values with your own customizations,
# please add them to `override/bn.yml`.
# 
# See https://docs.docker.com/compose/extends/#adding-and-overriding-configuration
# for more information on overriding specific parameters of docker-compose files.

services:
  {{.Hyperdrive.BeaconNodeContainerName}}:
    image: {{.Hyperdrive.GetBnContainerTag}}
    user: root
    container_name: {{.Hyperdrive.ProjectName}}_{{.Hyperdrive.BeaconNodeContainerName}}
    restart: unless-stopped
    stop_grace_period: 3m
    {{- $p2p := (or .Hyperdrive.LocalBeaconClient.P2pPort.String "9001")}}
    ports:
      - "{{$p2p}}:{{$p2p}}/udp"
      - "{{$p2p}}:{{$p2p}}/tcp"
      {{- if eq .Hyperdrive.LocalBeaconClient.BeaconNode.String "lighthouse"}}
      - "{{.Hyperdrive.LocalBeaconClient.Lighthouse.P2pQuicPort}}:{{.Hyperdrive.LocalBeaconClient.Lighthouse.P2pQuicPort}}/udp"
      {{- end}}
      {{- range $entry := .Hyperdrive.GetBnOpenPorts}}
      - "{{$entry}}"
      {{- end}}
    volumes:
      - {{.Hyperdrive.BeaconNodeDataVolume}}:/ethclient
      - /usr/share/hyperdrive/scripts:/usr/share/hyperdrive/scripts:ro
      - /var/lib/hyperdrive/data/{{.Hyperdrive.ProjectName}}:/secrets:ro
    networks:
      - hyperdrive-network
    environment:
      - NETWORK={{.Hyperdrive.Network}}
      - CLIENT={{.Hyperdrive.LocalBeaconClient.BeaconNode}}
      - EC_HTTP_ENDPOINT={{.Hyperdrive.GetEcHttpEndpoint}}
      - EC_WS_ENDPOINT={{.Hyperdrive.GetEcWsEndpoint}}
      - EC_ENGINE_ENDPOINT=http://{{.Hyperdrive.GetExecutionHostname}}:{{.Hyperdrive.LocalExecutionClient.EnginePort}}
      - EC_ENGINE_WS_ENDPOINT=ws://{{.Hyperdrive.GetExecutionHostname}}:{{.Hyperdrive.LocalExecutionClient.EnginePort}}
      - BN_P2P_PORT={{$p2p}}
      - BN_API_PORT={{.Hyperdrive.LocalBeaconClient.HttpPort}}
      - BN_MAX_PEERS={{.Hyperdrive.GetBnMaxPeers}}
      - ENABLE_METRICS={{.Hyperdrive.Metrics.EnableMetrics}}
      - BN_METRICS_PORT={{.Hyperdrive.Metrics.BnMetricsPort}}
      - EXTERNAL_IP={{.Hyperdrive.GetExternalIP}}
      - CHECKPOINT_SYNC_URL={{.Hyperdrive.LocalBeaconClient.CheckpointSyncProvider}}
      - BN_ADDITIONAL_FLAGS={{.Hyperdrive.GetBnAdditionalFlags}}
      - ENABLE_BITFLY_NODE_METRICS={{.Hyperdrive.Metrics.EnableBitflyNodeMetrics}}
      - BITFLY_NODE_METRICS_SECRET={{.Hyperdrive.Metrics.BitflyNodeMetrics.Secret}}
      - BITFLY_NODE_METRICS_ENDPOINT={{.Hyperdrive.Metrics.BitflyNodeMetrics.Endpoint}}
      - BITFLY_NODE_METRICS_MACHINE_NAME={{.Hyperdrive.Metrics.BitflyNodeMetrics.MachineName}}
      {{- /* Client-specific values */}}
      {{- if eq .Hyperdrive.LocalBeaconClient.BeaconNode.String "teku"}}
      - TEKU_JVM_HEAP_SIZE={{.Hyperdrive.LocalBeaconClient.Teku.JvmHeapSize}}
      - TEKU_ARCHIVE_MODE={{.Hyperdrive.LocalBeaconClient.Teku.ArchiveMode}}
      {{- else if eq .Hyperdrive.LocalBeaconClient.BeaconNode.String "prysm"}}
      - BN_RPC_PORT={{.Hyperdrive.LocalBeaconClient.Prysm.RpcPort}}
      {{- else if eq .Hyperdrive.LocalBeaconClient.BeaconNode.String "nimbus"}}
      - NIMBUS_PRUNING_MODE={{.Hyperdrive.LocalBeaconClient.Nimbus.PruningMode}}
      {{- else if eq .Hyperdrive.LocalBeaconClient.BeaconNode.String "lighthouse"}}
      - BN_P2P_QUIC_PORT={{.Hyperdrive.LocalBeaconClient.Lighthouse.P2pQuicPort}}
      {{- end}}
    entrypoint: sh
    command: "/usr/share/hyperdrive/scripts/{{.Hyperdrive.GetBnStartScript}}"
    cap_drop:
      - all
    cap_add:
      - dac_override
    security_opt:
      - no-new-privileges
networks:
  hyperdrive-network:
    name: {{.Hyperdrive.DockerNetwork}}
    external: true
volumes:
  {{.Hyperdrive.BeaconNodeDataVolume}}:
